<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>benchmark</title>
  </head>
  <body>
    <pre id="output"></pre>
    <script type="module">
      async function loader (useWasm) {
        const fetchText = url => fetch(url).then(response => response.text())
        const pianolizerImplementation = useWasm
          ? 'js/pianolizer-wasm.js'
          : 'js/pianolizer.js'
        const modules = await Promise.all([
          fetchText(pianolizerImplementation),
          fetchText('js/benchmark.js')
        ])
        const patchedModules = modules.map(
          str => str.replace(/\b(export\b|import\s+\{.+?\n)/gs, '') // hackity-hack
        )
        const blob = new Blob(patchedModules, { type: 'application/javascript' })

        const worker = new Worker(URL.createObjectURL(blob))
        return new Promise(resolve => {
          worker.onmessage = e => resolve(e.data)
        })
      }

      async function benchmark () {
        const output = document.getElementById('output')
        output.innerText = window.navigator.userAgent
        output.innerText += '\ntesting Pure JS...\n'
        output.innerText += await loader(false)
        output.innerText += '\ntesting WASM...\n'
        output.innerText += await loader(true)
        output.innerText += 'finished!'
      }

      benchmark()
    </script>
  </body>
</html>