<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>ðŸŽ¹</title>
    <script src="js/visualization.js"></script>
    <style>
      body {
        background-color: #000;
        color: #fff;
        font-family: "Arial", Times, serif;
      }
      .piano-key {
        stroke: #444;
        fill: #000;
      }
    </style>
  </head>
  <body>
    <div>
      <label>
        Source:
        <select id="source">
          <option value="*">ðŸŽ™ Microphone</option>
          <option value="audio/mazurka.webm" selected="selected">Chopin Mazurka in F minor, op. 68 no. 4 (by Pianotomy)</option>
          <option value="audio/chromatic.mp3">Chromatic scale on a piano, ascending</option>
          <option value="audio/sin.wav">Sine wave, 440 Hz</option>
          <option value="audio/saw.wav">Sawtooth wave, 440 Hz</option>
          <option value="audio/squ.wav">Square wave, 440 Hz</option>
          <option value="audio/noise.wav">Pink noise</option>
        </select>
      </label>
      Palette rotation:
      <input id="rotation" type="range" min="0" max="11" step="1" value="0"/>
      Smoothing:
      <input id="smoothing" type="range" min="0" max="0.25" step="any" value="0.05"/>
    </div>
    <div>
      <audio id="input" src="audio/mazurka.webm" controls></audio>
    </div>
    <div style="text-align: center">
      <canvas id="spectrogram"></canvas>
      <br>
      <svg id="keyboard"></svg>
    </div>
    <script>
      /* global PianoKeyboard, Spectrogram, Palette */
      const audioElement = document.getElementById('input')

      const pianoKeyboard = new PianoKeyboard(document.getElementById('keyboard'))
      const spectrogram = new Spectrogram(
        document.getElementById('spectrogram'),
        pianoKeyboard.keySlices
      )

      let audioContext, audioSource, microphoneSource, sdft
      let levels, lastTimestamp, palette

      function draw (currentTimestamp) {
        if (levels !== undefined && currentTimestamp !== lastTimestamp) {
          const keyColors = palette.getKeyColors(levels)
          pianoKeyboard.update(keyColors)
          spectrogram.update(keyColors)
          lastTimestamp = currentTimestamp
        }
      }

      async function setupAudio () {
        if (audioContext === undefined) {
          await fetch('palette.json')
            .then(response => response.json())
            .then(data => { palette = new Palette(data) })

          audioContext = new (window.AudioContext || window.webkitAudioContext)()
          await audioContext.audioWorklet.addModule('js/sdft.js')
          sdft = new AudioWorkletNode(audioContext, 'sliding-dft-node')
          sdft.port.onmessage = event => {
            // TODO: use SharedArrayBuffer for syncing levels
            levels = event.data
            window.requestAnimationFrame(draw)
          }

          audioSource = audioContext.createMediaElementSource(audioElement)
          audioSource.connect(sdft)
        }

        sdft.connect(audioContext.destination)
      }

      async function setupMicrophone () {
        await setupAudio()
        sdft.disconnect(audioContext.destination)

        if (microphoneSource === undefined) {
          navigator.getUserMedia =
            navigator.getUserMedia ||
            navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia
          navigator.getUserMedia(
            { audio: true, video: false },
            stream => {
              microphoneSource = audioContext.createMediaStreamSource(stream)
              microphoneSource.connect(sdft)
            },
            () => window.alert('Microphone access denied')
          )
        } else {
          microphoneSource.connect(sdft)
        }
      }

      document.getElementById('source').onchange = event => {
        audioElement.pause()

        const selectedValue = event.target.value
        if (selectedValue === '*') {
          // microphone source
          audioElement.style['pointer-events'] = 'none'
          setupMicrophone()
        } else {
          // <audio> element source
          try { microphoneSource.disconnect(sdft) } catch { console.warn('Microphone was not connected') }
          audioElement.style['pointer-events'] = 'auto'
          audioElement.src = selectedValue
        }
      }

      audioElement.onplay = () => {
        setupAudio()
        audioElement.play()
      }

      document.getElementById('rotation').oninput = event => {
        if (palette !== undefined) {
          palette.rotation = event.target.value
        }
      }

      document.getElementById('smoothing').oninput = event => {
        if (sdft !== undefined) {
          sdft.parameters.get('smooth').value = event.target.value
        }
      }
    </script>
  </body>
</html>