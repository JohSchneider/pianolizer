<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>sdft</title>
        <script src="piano.js"></script>
        <style>
          body {
            background-color: #000;
          }
          .piano-key {
            stroke: #444;
            fill: #000;
          }
        </style>
    </head>
    <body>
        <audio id="input" src="chromatic.mp3" controls></audio>
        <svg id="output" width="1280" height="150"></svg>
        <script>
            // eslint-disable-next-line no-undef
            const keyboard = new PianoKeyboard(document.querySelector('#output'))
            keyboard.drawKeyboard()

            const ac = new AudioContext()
            const audioElement = document.querySelector('#input')
            const source = ac.createMediaElementSource(audioElement)

            async function play () {
              let palette
              await fetch('palette.json')
                .then(response => response.json())
                .then(data => { palette = data })

              await ac.audioWorklet.addModule('sdft.js')
              ac.resume()
              audioElement.play()

              const sdft = new AudioWorkletNode(ac, 'sliding-dft-node')
              sdft.port.onmessage = event => {
                if (event.data.levels) {
                  for (let i = 0; i < keyboard.keys.length; i++) {
                    const level = event.data.levels[i]
                    const color = palette[(i + 9) % 12].map(c =>
                      Math.round(level * c)
                        .toString(16)
                        .padStart(2, '0')
                    )
                    keyboard.keys[i].style.fill = `#${color[0]}${color[1]}${color[2]}`
                  }
                }
              }
              source.connect(sdft).connect(ac.destination)
            }

            audioElement.addEventListener('play', () => {
              play()
            })
            audioElement.addEventListener('ended', () => {
              ac.suspend()
            })
        </script>
    </body>
</html>