<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>sdft</title>
        <script src="js/piano.js"></script>
        <style>
          body {
            background-color: #000;
          }
          .piano-key {
            stroke: #444;
            fill: #000;
          }
        </style>
    </head>
    <body>
        <select>
          <option value="audio/mazurka.webm">Chopin Mazurka in F minor, op. 68 no. 4 (by Pianotomy)</option>
          <option value="audio/chromatic.mp3">Chromatic scale on a piano, ascending</option>
          <option value="audio/sin.wav">Sine wave, 440 Hz</option>
          <option value="audio/saw.wav">Sawtooth wave, 440 Hz</option>
          <option value="audio/squ.wav">Square wave, 440 Hz</option>
          <option value="audio/noise.wav">Pink noise</option>
        </select>
        <br>
        <audio id="input" src="audio/mazurka.webm" controls></audio>
        <svg id="output" width="1280" height="150"></svg>
        <script>
            // eslint-disable-next-line no-undef
            const keyboard = new PianoKeyboard(document.querySelector('#output'))
            keyboard.drawKeyboard()

            const ac = new AudioContext()
            const audioElement = document.querySelector('#input')
            const source = ac.createMediaElementSource(audioElement)

            let loaded = 0
            async function play () {
              if (loaded === 0) {
                let palette
                await fetch('palette.json')
                  .then(response => response.json())
                  .then(data => { palette = data })

                await ac.audioWorklet.addModule('js/sdft.js')

                const sdft = new AudioWorkletNode(ac, 'sliding-dft-node')
                sdft.port.onmessage = event => {
                  if (event.data.levels) {
                    for (let i = 0; i < keyboard.keys.length; i++) {
                      const level = event.data.levels[i]
                      const color = palette[(i + 9) % 12].map(c =>
                        Math.round(level * c)
                          .toString(16)
                          .padStart(2, '0')
                      )
                      keyboard.keys[i].style.fill = `#${color[0]}${color[1]}${color[2]}`
                    }
                  }
                }
                source.connect(sdft).connect(ac.destination)
                loaded++
              }

              ac.resume()
              audioElement.play()
            }

            document.querySelector('select').addEventListener('change', event => {
              ac.suspend()
              audioElement.pause()
              audioElement.src = event.target.value
            })
            audioElement.addEventListener('play', () => {
              play()
            })
            audioElement.addEventListener('ended', () => {
              ac.suspend()
            })
        </script>
    </body>
</html>