<!DOCTYPE html>
<html lang="en-US">
    <head>
        <title>sdft</title>
        <script src="js/piano.js"></script>
        <style>
          body {
            background-color: #000;
          }
          .piano-key {
            stroke: #444;
            fill: #000;
          }
        </style>
    </head>
    <body>
        <select>
          <option value="*">ðŸŽ™</option>
          <option value="audio/mazurka.webm" selected="selected">Chopin Mazurka in F minor, op. 68 no. 4 (by Pianotomy)</option>
          <option value="audio/chromatic.mp3">Chromatic scale on a piano, ascending</option>
          <option value="audio/sin.wav">Sine wave, 440 Hz</option>
          <option value="audio/saw.wav">Sawtooth wave, 440 Hz</option>
          <option value="audio/squ.wav">Square wave, 440 Hz</option>
          <option value="audio/noise.wav">Pink noise</option>
        </select>
        <br>
        <audio id="input" src="audio/mazurka.webm" controls></audio>
        <svg id="output" width="1280" height="150"></svg>
        <script>
            // eslint-disable-next-line no-undef
            const pianoKeyboard = new PianoKeyboard(document.querySelector('#output'))
            pianoKeyboard.drawKeyboard()

            const audioElement = document.querySelector('#input')

            let isLoaded = false
            let audioContext
            let audioSource
            let sdft
            async function setup () {
              if (isLoaded === false) {
                let palette
                await fetch('palette.json')
                  .then(response => response.json())
                  .then(data => { palette = data })

                audioContext = new (window.AudioContext || window.webkitAudioContext)()
                audioSource = audioContext.createMediaElementSource(audioElement)
                await audioContext.audioWorklet.addModule('js/sdft.js')
                sdft = new AudioWorkletNode(audioContext, 'sliding-dft-node')
                sdft.port.onmessage = event => {
                  if (event.data.levels) {
                    for (let key = 0; key < pianoKeyboard.keys.length; key++) {
                      const level = event.data.levels[key]
                      const rgbArray = palette[(key + 9) % 12]
                        .map(value => Math.round(level * value) | 0)
                      const rgbInteger =
                        (rgbArray[0] << 16) +
                        (rgbArray[1] << 8) +
                        (rgbArray[2])
                      const rgbString = rgbInteger
                        .toString(16)
                        .padStart(6, '0')
                      pianoKeyboard.keys[key].style.fill = '#' + rgbString
                    }
                  }
                }
                isLoaded = true
              } else {
                audioSource.disconnect(sdft)
              }

              audioSource.connect(sdft)
              sdft.connect(audioContext.destination)
              audioContext.resume()
              audioElement.play()
            }

            document.querySelector('select').addEventListener('change', event => {
              if (audioContext !== undefined) {
                audioContext.suspend()
              }
              audioElement.pause()

              const selectedValue = event.target.value
              if (selectedValue === '*') {
                audioElement.style['pointer-events'] = 'none'
              } else {
                audioElement.style['pointer-events'] = 'auto'
                audioElement.src = selectedValue
              }
            })

            audioElement.addEventListener('play', () => setup())
            audioElement.addEventListener('pause', () => audioContext.suspend())
            audioElement.addEventListener('ended', () => audioContext.suspend())
        </script>
    </body>
</html>