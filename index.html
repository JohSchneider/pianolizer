<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>ðŸŽ¹</title>
    <style>
      body {
        background-color: #000;
        color: #fff;
        font-family: "Arial", Times, serif;
        font-size: 12px;
      }
      label {
        font-weight: bold;
      }
      a {
        color: #fff;
      }
      button {
        width: 5rem;
      }
      input[type=range] {
        -webkit-appearance: none;
        border-radius: 10px;
        height: 10px;
        width: 5rem;
      }
      #controls {
        text-align: center;
      }
      #smoothing-value {
        font-family: monospace;
      }
      #pianolizer {
        position: relative;
        text-align: center;
      }
      #help {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        left: 0;
        right: 0;
        z-index: -1;
        overflow: hidden;
      }
      .piano-key {
        stroke: #666;
        fill: #000;
      }
      .piano-key-label {
        font-family: monospace;
        font-size: 12px;
        fill: #888;
      }
      #footer {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <label>
        Source:
        <select id="source">
          <option value="*">ðŸŽ™ Microphone</option>
          <option value="/">Load local audio file</option>
          <option value="audio/mazurka.mp3" selected="selected">Chopin Mazurka in F minor, op. 68 no. 4 (by Pianotomy)</option>
          <option value="audio/chromatic.mp3">Chromatic scale on a piano, ascending</option>
          <option value="audio/sin.flac">Sine wave, 440 Hz</option>
          <option value="audio/saw.flac">Sawtooth wave, 440 Hz</option>
          <option value="audio/squ.flac">Square wave, 440 Hz</option>
          <option value="audio/noise.flac">Pink noise</option>
        </select>
      </label>
      <audio id="input" src="audio/mazurka.mp3" loop></audio>
      <button id="play-toggle">Play</button>
      <button id="play-restart">Restart</button>
      <label>
        Palette rotation:
        <input id="rotation" type="range" min="0" max="11" step="1" value="0"/>
      </label>
      <label>
        Smoothing:
        <input id="smoothing" type="range" min="0" max="0.25" step="any" value="0.04"/>
        (<span id="smoothing-value">0.040</span>s)
      </label>
      |
      Switch to <a id="implementation"></a>
    </div>
    <div id="pianolizer">
      <div id="help">
        <h1>Select the source from the dropdown menu and press play.</h1>
        <h2>Safari kind of works but the performance is terrible.</h2>
        <h2>Firefox & Safari do not support the local file source.</h2>
        <h2>Chrome is recommended for the best experience :)</h2>
      </div>
      <canvas id="spectrogram"></canvas>
      <br>
      <svg id="keyboard"></svg>
    </div>
    <div id="footer">
      MIT License -
      Copyright &copy; 2022 Stanislaw Pusep -
      <a href="https://github.com/creaktive/pianolizer" target="_blank">github.com/creaktive/pianolizer</a>
    </div>
    <script type="module">
      import { PianoKeyboard, Spectrogram, Palette } from './js/visualization.js'

      let audioContext, audioSource, microphoneSource, pianolizer
      let levels, lastTimestamp, palette

      fetch('palette.json')
        .then(response => response.json())
        .then(data => { palette = new Palette(data) })

      const audioElement = document.getElementById('input')
      const playToggle = document.getElementById('play-toggle')
      const playRestart = document.getElementById('play-restart')

      const pianoKeyboard = new PianoKeyboard(document.getElementById('keyboard'))
      pianoKeyboard.drawKeyboard()
      const spectrogram = new Spectrogram(
        document.getElementById('spectrogram'),
        pianoKeyboard.keySlices,
        600
      )

      const midi = new Float32Array(pianoKeyboard.keysNum)
      if (navigator.requestMIDIAccess) {
        console.log('This browser supports WebMIDI!')
        navigator.requestMIDIAccess().then(
          midiAccess => {
            console.log('onMIDISuccess, got MIDI: ', midiAccess)
            // connecting MIDI to input function
            for (const input of midiAccess.inputs.values()) {
              input.onmidimessage = message => {
                const firstNoteIndex = 36
                const [command, note, velocity] = message.data
                switch (command) {
                  case 0x90:
                    midi[note - firstNoteIndex] = velocity / 0x7f
                    break
                  case 0x80:
                    midi[note - firstNoteIndex] = 0
                    break
                }
              }
            }
          },
          () => console.log('Could not access your MIDI devices.')
        )
      } else {
        console.log('WebMIDI is not supported in this browser.')
      }

      function draw (currentTimestamp) {
        if (
          (playToggle.disabled === true || !audioElement.paused) &&
          levels !== undefined &&
          palette !== undefined &&
          currentTimestamp !== lastTimestamp
        ) {
          const audioColors = palette.getKeyColors(levels)
          const midiColors = palette.getKeyColors(midi)
          pianoKeyboard.update(audioColors, midiColors)
          spectrogram.update(audioColors, midiColors)
          lastTimestamp = currentTimestamp
        }
      }

      function isPureJS () {
        return window.location.search.toLowerCase() === '?purejs'
      }

      async function setupAudio () {
        if (audioContext === undefined) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)()

          // Thanks for nothing, Firefox!
          // https://bugzilla.mozilla.org/show_bug.cgi?id=1572644
          // https://bugzilla.mozilla.org/show_bug.cgi?id=1636121
          // https://github.com/WebAudio/web-audio-api-v2/issues/109#issuecomment-756634198
          const fetchText = url => fetch(url).then(response => response.text())
          const pianolizerImplementation = isPureJS()
            ? 'js/pianolizer.js'
            : 'js/pianolizer-wasm.js'
          const modules = await Promise.all([
            fetchText(pianolizerImplementation),
            fetchText('js/pianolizer-worklet.js')
          ])
          const blob = new Blob(modules, { type: 'application/javascript' })
          await audioContext.audioWorklet.addModule(URL.createObjectURL(blob))

          pianolizer = new AudioWorkletNode(audioContext, 'pianolizer-worklet')
          pianolizer.port.onmessage = event => {
            // TODO: use SharedArrayBuffer for syncing levels
            levels = event.data
            window.requestAnimationFrame(draw)
          }

          audioSource = audioContext.createMediaElementSource(audioElement)
          audioSource.connect(pianolizer)
        }

        audioSource.connect(audioContext.destination)
        pianolizer.parameters.get('smooth').value = parseFloat(document.getElementById('smoothing').value)
      }

      async function setupMicrophone () {
        await setupAudio()
        audioSource.disconnect(audioContext.destination)

        if (microphoneSource === undefined) {
          await navigator.mediaDevices.getUserMedia(
            { audio: true, video: false }
          ).then(stream => {
            microphoneSource = audioContext.createMediaStreamSource(stream)
            microphoneSource.connect(pianolizer)
          }).catch(error => window.alert('Microphone access denied: ' + error))
        } else {
          microphoneSource.connect(pianolizer)
        }
      }

      async function loadLocalFile () {
        const fileHandles = await window.showOpenFilePicker({
          types: [
            {
              description: 'Audio',
              accept: {
                'audio/*': ['.mp3', '.flac', '.ogg', '.webm', '.wav']
              }
            }
          ],
          excludeAcceptAllOption: true,
          multiple: false
        })
        const fileData = await fileHandles[0].getFile()
        audioElement.src = URL.createObjectURL(fileData)
      }

      document.getElementById('source').selectedIndex = 2 // Mazurka
      document.getElementById('source').onchange = event => {
        audioElement.pause()
        playToggle.innerText = 'Play'

        const selectedValue = event.target.value
        if (selectedValue === '*') {
          // microphone source
          playToggle.disabled = true
          playRestart.disabled = true
          setupMicrophone()
        } else {
          // <audio> element source
          playToggle.disabled = false
          playRestart.disabled = false
          try { microphoneSource.disconnect(pianolizer) } catch { console.warn('Microphone was not connected') }
          audioElement.style['pointer-events'] = 'auto'
          if (selectedValue === '/') {
            // only Chrome & Opera can do this at the time of writing
            loadLocalFile()
          } else {
            audioElement.src = `${selectedValue}?_=${Date.now()}` // never cache
          }
        }
      }

      playToggle.onclick = async event => {
        if (audioElement.paused) {
          await setupAudio()
          audioElement.play()
          playToggle.innerText = 'Pause'
        } else {
          audioElement.pause()
          playToggle.innerText = 'Play'
        }
      }

      playRestart.onclick = event => {
        audioElement.load()
        playToggle.innerText = 'Play'
      }

      document.getElementById('rotation').oninput = event => {
        if (palette !== undefined) {
          palette.rotation = event.target.value
        }
      }

      document.getElementById('smoothing').oninput = event => {
        const value = parseFloat(event.target.value)
        document.getElementById('smoothing-value').innerText = value.toFixed(3)
        if (pianolizer !== undefined) {
          pianolizer.parameters.get('smooth').value = value
        }
      }

      const implementationSwitch = document.getElementById('implementation')
      const myURL = window.location.href.replace(/\?.*/, '')
      if (isPureJS()) {
        implementationSwitch.href = myURL
        implementationSwitch.innerText = 'WASM'
      } else {
        implementationSwitch.href = myURL + '?purejs'
        implementationSwitch.innerText = 'Pure JS'
      }

      // FIXME: Safari only works when microphone access is set up
      if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1) {
        navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      }
    </script>
  </body>
</html>